<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Conversor de Imágenes</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body>
    <header>
        <div class="container">
            <h1>Conversor de Imágenes</h1>
        </div>
    </header>
    <main>
        <div class="container">
            <p class="intro-text">
                Bienvenido al conversor de imágenes. Aquí podrás convertir tus imágenes a diferentes formatos de manera rápida y sencilla.
                Sube tus imágenes arrastrándolas a la zona indicada o haciendo clic en el botón "Seleccionar Imágenes".
                Puedes ajustar la calidad y resolución de las imágenes antes de convertirlas.
                Una vez que hayas subido tus imágenes, haz clic en "Convertir" para iniciar el proceso.
            </p>
            <p class="error"></p>
            <form id="registerForm" class="login-form">
                <input type="text" id="registerUsername" placeholder="Username" required>
                <input type="password" id="registerPassword" placeholder="Password" required>
                <button type="submit">Register</button>
            </form>
            <form id="loginForm" class="login-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <button id="logoutButton" style="display: none;">Logout</button>
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                <div class="drop-area" id="drop-area">
                    <p>Arrastra y suelta las imágenes aquí o haz clic para seleccionar</p>
                    <input type="file" name="files" multiple accept="image/*" id="fileInput" style="display: none;">
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label for="quality">Calidad predeterminada:</label>
                        <input type="range" id="quality" name="quality" min="1" max="100" value="95">
                        <span id="qualityValue">95</span>
                    </div>
                    <div class="control-group">
                        <label for="resolution">Resolución predeterminada:</label>
                        <input type="range" id="resolution" name="resolution" min="1" max="100" value="100">
                        <span id="resolutionValue">100</span>
                    </div>
                    <div class="control-group">
                        <label for="output_format">Formato de Salida predeterminado:</label>
                        <select name="output_format" id="output_format">
                            <option value="original">Original</option>
                            <option value="png">PNG</option>
                            <option value="jpg">JPG</option>
                            <option value="webp">WebP</option>
                            <option value="avif">AVIF</option>
                            <option value="bmp">BMP</option>
                            <option value="tiff">TIFF</option>
                            <option value="ico">ICO</option>
                        </select>
                    </div>
                </div>
                <button type="button" id="convertButton">Convertir</button>
            </form>
            <button type="button" id="removeAllButton" class="remove-all-button">Eliminar Todas las Imágenes</button>
            <div id="progress-container">
                <div id="progress-bar"></div>
                <p id="progress-text">Procesando imágenes...</p>
            </div>
            <div id="results-container">
                <h2>Archivos Seleccionados</h2>
                <ul id="files-list" class="files-grid">
                </ul>
            </div>
        </div>
    </main>
    <footer>
        <div class="container">
            <p>© 2023 Conversor de Imágenes</p>
        </div>
    </footer>
    <script>
        const qualityInput = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');
        const resolutionInput = document.getElementById('resolution');
        const resolutionValue = document.getElementById('resolutionValue');
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('fileInput');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressContainer = document.getElementById('progress-container');
        const filesList = document.getElementById('files-list');
        const uploadForm = document.getElementById('uploadForm');
        const convertButton = document.getElementById('convertButton');
        const errorElement = document.querySelector('.error');
        let uploadedFiles = {};
        let jobIds = [];
        let completedImages = 0; // Number of completed images, not jobs
        let isProcessing = false;
        let processedFiles = {};
        const registerForm = document.getElementById('registerForm');
        const loginForm = document.getElementById('loginForm');
        const logoutButton = document.getElementById('logoutButton');
        let totalImagesToProcess = 0; // Total number of images to be processed
        let globalRequestId = null; // Variable to store the request ID
        let jobFileMap = {}; // Map to store job_id to fileKey mapping
        let imageCounter = 0; // Counter for generating unique image IDs

        // Function to check if the user is logged in
        function isLoggedIn() {
            return localStorage.getItem('jwtToken') !== null;
        }

        // Function to show/hide elements based on login status
        function updateUI() {
            if (isLoggedIn()) {
                registerForm.style.display = 'none';
                loginForm.style.display = 'none';
                logoutButton.style.display = 'block';
                convertButton.style.display = 'block'; // Show convert button
                dropArea.classList.remove('disabled'); // Enable drop area
            } else {
                registerForm.style.display = 'block';
                loginForm.style.display = 'block';
                logoutButton.style.display = 'none';
                convertButton.style.display = 'none'; // Hide convert button
                dropArea.classList.add('disabled'); // Disable drop area
            }
        }

        // Call updateUI on page load
        updateUI();

        qualityInput.addEventListener('input', function () {
            qualityValue.textContent = qualityInput.value;
        });

        resolutionInput.addEventListener('input', function () {
            resolutionValue.textContent = resolutionInput.value;
        });

        function formatFileSize(bytes) {
            if (bytes >= 1024 * 1024) {
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            } else if (bytes >= 1024) {
                return (bytes / 1024).toFixed(2) + ' KB';
            }
            return bytes + ' bytes';
        }

        function generateThumbnail(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 100;
                    const MAX_HEIGHT = 100;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    callback(canvas.toDataURL('image/jpeg'), img.width, img.height);
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        function generateFileKey(file) {
            return `${file.name}-${file.size}-${file.lastModified}`;
        }

        function displayFileItem(file, index) {
            const key = generateFileKey(file);
            let listItem = document.getElementById(`file-item-${key}`);
            const defaultOutputFormat = document.getElementById('output_format').value;

            if (!listItem) {
                generateThumbnail(file, function(thumbnail, width, height) {
                    listItem = document.createElement('li');
                    listItem.classList.add('file-item');
                    listItem.id = `file-item-${key}`;

                    // Get file extension safely
                    const fileNameParts = file.name.split('.');
                    const fileExtension = fileNameParts.length > 1 ? fileNameParts.pop().toLowerCase() : ''; // Handle cases with no extension
                    const fileResolution = `${width}x${height}`;

                    listItem.innerHTML = `
                        <div class="thumbnail-container">
                            <img src="${thumbnail}" alt="Thumbnail" class="thumbnail">
                            <div class="loader"></div>
                        </div>
                        <div class="file-info">
                            <p><strong>Nombre:</strong> ${file.name}</p>
                            <p><strong>Extensión:</strong> ${fileExtension}</p>
                            <p><strong>Tamaño:</strong> ${formatFileSize(file.size)}</p>
                            <p><strong>Resolución:</strong> ${fileResolution}</p>
                            <div class="file-settings">
                                <label for="quality-${key}">Calidad:</label>
                                <input type="range" id="quality-${key}" name="quality-${key}" min="1" max="100" value="${qualityInput.value}">
                                <span id="qualityValue-${key}">${qualityInput.value}</span>
                                <label for="resolution-${key}">Resolución:</label>
                                <input type="range" id="resolution-${key}" name="resolution-${key}" min="1" max="100" value="${resolutionInput.value}">
                                <span id="resolutionValue-${key}">${resolutionInput.value}</span>
                                <label for="output_format-${key}">Formato de Salida:</label>
                                <select name="output_format-${key}" id="output_format-${key}">
                                    <option value="original" ${defaultOutputFormat === 'original' ? 'selected' : ''}>Original</option>
                                    <option value="png" ${defaultOutputFormat === 'png' ? 'selected' : ''}>PNG</option>
                                    <option value="jpg" ${defaultOutputFormat === 'jpg' ? 'selected' : ''}>JPG</option>
                                    <option value="webp" ${defaultOutputFormat === 'webp' ? 'selected' : ''}>WebP</option>
                                    <option value="avif" ${defaultOutputFormat === 'avif' ? 'selected' : ''}>AVIF</option>
                                    <option value="bmp" ${defaultOutputFormat === 'bmp' ? 'selected' : ''}>BMP</option>
                                    <option value="tiff" ${defaultOutputFormat === 'tiff' ? 'selected' : ''}>TIFF</option>
                                    <option value="ico" ${defaultOutputFormat === 'ico' ? 'selected' : ''}>ICO</option>
                                </select>
                            </div>
                        <button type="button" class="remove-file" data-key="${key}">X</button>
                    `;
                    filesList.appendChild(listItem);

                    document.getElementById(`quality-${key}`).addEventListener('input', function() {
                        document.getElementById(`qualityValue-${key}`).textContent = this.value;
                    });

                    document.getElementById(`resolution-${key}`).addEventListener('input', function() {
                        document.getElementById(`resolutionValue-${key}`).textContent = this.value;
                    });

                    const removeButton = listItem.querySelector('.remove-file');
                    removeButton.addEventListener('click', function() {
                        const key = this.getAttribute('data-key');
                        delete uploadedFiles[key];
                        delete processedFiles[key];
                        const listItem = document.getElementById(`file-item-${key}`);
                        if (listItem) {
                            listItem.remove();
                        }
                        fileInput.value = '';
                    });
                });
            } else {
                generateThumbnail(file, function(thumbnail, width, height) {
                    const thumbnailElement = listItem.querySelector('.thumbnail');
                    thumbnailElement.src = thumbnail;

                    const nameElement = listItem.querySelector('.file-info p strong:nth-child(1)');
                    nameElement.textContent = file.name;

                    const extensionElement = listItem.querySelector('.file-info p strong:nth-child(2)');
                    extensionElement.textContent = file.name.split('.').pop();

                    const sizeElement = listItem.querySelector('.file-info p strong:nth-child(3)');
                    sizeElement.textContent = formatFileSize(file.size);

                    const resolutionElement = listItem.querySelector('.file-info p strong:nth-child(4)');
                    resolutionElement.textContent = `${width}x${height}`;
                });
            }
        }

        function handleFiles(files) {
            if (!isLoggedIn()) {
                alert('Please log in to upload files.');
                return;
            }
            for (let i = 0; i < files.length; i++) {
                if (files[i].size > (10 * 1024 * 1024)) {
                    alert('El archivo ' + files[i].name + ' excede el tamaño máximo de 10 MB.');
                    continue;
                }
                const file = files[i];
                const key = generateFileKey(file);
                if (!uploadedFiles[key]) {
                    uploadedFiles[key] = file;
                    displayFileItem(file);
                }
            }
        }

        function uploadFiles() {
            console.log("uploadFiles called");
            if (!isLoggedIn()) {
                console.log("User not logged in");
                alert('Please log in to convert images.');
                return;
            }
            if (isProcessing) {
                console.log("Already processing");
                return;
            }

            const filesToUpload = [];
            const filesData = [];

            // Reprocess all images
            for (const key in uploadedFiles) {
                if (uploadedFiles.hasOwnProperty(key)) {
                    const file = uploadedFiles[key];
                    const currentQuality = parseInt(document.getElementById(`quality-${key}`).value);
                    const currentResolution = parseInt(document.getElementById(`resolution-${key}`).value);
                    const currentOutputFormat = document.getElementById(`output_format-${key}`).value;

                    filesToUpload.push(file);
                    filesData.push({
                        key: key,
                        quality: currentQuality,
                        resolution: currentResolution,
                        output_format: currentOutputFormat
                    });
                }
            }

            if (filesToUpload.length === 0) {
                console.log("No images to upload");
                alert('No hay imágenes para procesar.');
                return;
            }

            isProcessing = true;
            convertButton.disabled = true;
            dropArea.classList.add('disabled');
            const formData = new FormData();

            totalImagesToProcess = filesToUpload.length; // Set the total number of images
            console.log(`Total images to process: ${totalImagesToProcess}`);

            filesToUpload.forEach((file, index) => {
                formData.append('files', file);
                formData.append('file_keys[]', filesData[index].key); // Use an array to store all file keys
                formData.append('quality-' + filesData[index].key, filesData[index].quality);
                formData.append('resolution-' + filesData[index].key, filesData[index].resolution);
                formData.append('output_format-' + filesData[index].key, filesData[index].output_format);
            });

            console.log("FormData:", formData); // Debug form data

            const token = localStorage.getItem('jwtToken');
            const headers = {
                'Authorization': `Bearer ${token}`
            };

            fetch('/convert', {
                method: 'POST',
                headers: headers,
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                return response.json().then(data => {
                    if (response.status === 401) {
                    // Check for specific error message from the server
                    if (data.error === 'missing_token' || data.error === 'expired_token' || data.error === 'invalid_token') {
                        localStorage.removeItem('jwtToken'); // Remove token
                        updateUI(); // Update UI to logged-out state
                        throw new Error('Error: Debes iniciar sesión para convertir imágenes. Tu sesión ha expirado.');
                    } else {
                        throw new Error(data.error || 'Network response was not ok');
                    }
                    } else {
                    throw new Error(data.error || 'Network response was not ok');
                    }
                });
                }
                return response.json();
            })
            .then(data => {
                console.log("Respuesta del servidor:", data);
                if (data.error) {
                    errorElement.textContent = data.error;
                    errorElement.classList.add('show');
                    resetState();
                } else {
                    errorElement.classList.remove('show');
                    if (data && data.uploaded_files_info && Array.isArray(data.uploaded_files_info)) {
                        globalRequestId = data.request_id;
                        console.log(`Request ID: ${globalRequestId}`);
                        progressContainer.style.display = 'block';
                        window.onbeforeunload = function() {
                            return "Hay un proceso de conversión en curso, ¿seguro que quieres salir de la página?";
                        };
                        completedImages = 0;
                        progressBar.style.width = '0%';
                        progressText.textContent = 'Procesando imágenes...';

                        // Reset imageCounter for each new request
                        imageCounter = 0;

                        // Create a mapping of job IDs to file keys (as an array)
                        jobFileMap = {};
                        for (let i = 0; i < data.uploaded_files_info.length; i++) {
                            const fileInfo = data.uploaded_files_info[i];
                            const fileKey = fileInfo.key;
                            const job_id = Object.keys(data.results)[i]; // Get the job_id by index

                            if (!jobFileMap[fileKey]) {
                                jobFileMap[fileKey] = [];
                            }
                            jobFileMap[fileKey].push(job_id);
                            console.log(`Mapping job_id ${job_id} to fileKey ${fileKey}`);
                        }

                        for (const fileInfo of data.uploaded_files_info) {
                            const key = fileInfo.key;
                            if (uploadedFiles[key]) {
                                // Initialize as an array here
                                processedFiles[key] = []; 
                                processedFiles[key].push({
                                    status: 'processing'
                                });
                            }
                        }
                        checkProgress(globalRequestId);
                    } else {
                        console.error('Error: La respuesta del servidor no contiene uploaded_files_info o no es un array.');
                        resetState();
                    }
                }
            })
            .catch(error => {
            console.error('Error:', error);
            errorElement.textContent = error.message;
            errorElement.classList.add('show');
            resetState();
            });
        }

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            if (!isProcessing) {
                if (!isLoggedIn()) {
                    alert('Please log in to upload files.');
                    return;
                }
                const files = e.dataTransfer.files;
                fileInput.files = files;
                handleFiles(files);
            }
        });

        dropArea.addEventListener('click', () => {
            if (!isProcessing) {
                if (!isLoggedIn()) {
                    alert('Please log in to upload files.');
                    return;
                }
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', (e) => {
            if(!isProcessing){
                const files = e.target.files;
                handleFiles(files);
            }
        });

        convertButton.addEventListener('click', (e) => {
           e.preventDefault(); // Prevent default form submission
           uploadFiles();
        });

        document.getElementById('removeAllButton').addEventListener('click', function() {
            uploadedFiles = {};
            processedFiles = {};
            filesList.innerHTML = ''; // Clear the files list
            fileInput.value = ''; // Reset the file input
        });

        async function checkProgress(requestId) {
            console.log(`Checking progress for request ID ${requestId}`);
            try {
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    console.log('No JWT token found in local storage');
                    throw new Error('No JWT token found in local storage');
                }
                const headers = {
                    'Authorization': `Bearer ${token}`
                };
                const response = await fetch(`/progress/${requestId}`, { headers: headers });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('jwtToken');
                        updateUI();
                        throw new Error('Error: Debes iniciar sesión para convertir imágenes. Tu sesión ha expirado.');
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }

                const data = await response.json();
                console.log("Progress data:", data);

                if (data.error) {
                    progressText.textContent = `Error: ${data.error}`;
                    resetState();
                    return;
                }

                completedImages = data.completed;
                const progress = Math.round((completedImages / totalImagesToProcess) * 100);
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `Procesando imágenes... ${progress}%`;

                for (const job_id in data.results) {
                    console.log(`Processing job_id: ${job_id}`);
                    const jobResult = data.results[job_id];
                    const fileKey = jobResult.filekey;

                    if (!jobResult || !fileKey) {
                        console.log(`Skipping job_id ${job_id} because jobResult or fileKey is missing.`);
                        continue;
                    }

                    console.log(`fileKey for job_id ${job_id}: ${fileKey}`);
                    const listItem = document.getElementById(`file-item-${fileKey}`);

                    if (!listItem) {
                        console.log(`Skipping job_id ${job_id} because listItem not found for fileKey ${fileKey}.`);
                        continue;
                    }

                    // Create a unique download button container for each fileKey
                    let downloadButtonContainer = document.getElementById(`download-buttons-${fileKey}`);
                    if (!downloadButtonContainer) {
                        console.log(`Creating download button container for fileKey ${fileKey}`);
                        downloadButtonContainer = document.createElement('div');
                        downloadButtonContainer.id = `download-buttons-${fileKey}`; // Use fileKey for ID
                        downloadButtonContainer.classList.add('download-buttons');
                        listItem.appendChild(downloadButtonContainer);
                    } else {
                        console.log(`Download button container for fileKey ${fileKey} already exists. Clearing it.`);
                        downloadButtonContainer.innerHTML = ''; // Clear existing buttons
                    }

                    if (jobResult.status === 'finished' && jobResult.result) {
                        console.log(`Job ${job_id} is finished. Creating buttons.`);
                        const outputFilename = jobResult.result;
                        const originalFilename = jobResult.original_filename;
                        const token = localStorage.getItem('jwtToken');

                        // Create View link
                        const viewLink = document.createElement('a');
                        viewLink.href = `/file/${job_id}?token=${encodeURIComponent(token)}`;
                        viewLink.target = "_blank";
                        viewLink.textContent = `View`;
                        downloadButtonContainer.appendChild(viewLink);
                        console.log(`Appended View link for job_id ${job_id} to download-buttons-${fileKey}`);

                        // Create Download link
                        const downloadLink = document.createElement('a');
                        downloadLink.href = `/download/${job_id}?token=${encodeURIComponent(token)}`;
                        downloadLink.download = originalFilename;
                        downloadLink.textContent = `Download`;
                        downloadButtonContainer.appendChild(downloadLink);
                        console.log(`Appended Download link for job_id ${job_id} to download-buttons-${fileKey}`);

                        downloadButtonContainer.style.display = 'inline-block';

                        // Update processedFiles
                        if (!processedFiles[fileKey]) {
                            processedFiles[fileKey] = [];
                        }
                        processedFiles[fileKey].push({
                            status: 'processed',
                            jobId: job_id,
                            quality: parseInt(document.getElementById(`quality-${fileKey}`).value),
                            resolution: parseInt(document.getElementById(`resolution-${fileKey}`).value),
                            output_format: document.getElementById(`output_format-${fileKey}`).value
                        });

                        // Hide the loader
                        const loader = listItem.querySelector('.loader');
                        if (loader) {
                            loader.style.display = 'none';
                        }
                    } else if (jobResult.status === 'failed') {
                        console.log(`Job ${job_id} failed.`);
                        // Handle failed jobs
                        progressText.textContent = `Error al procesar la imagen (Job ID: ${job_id.substring(0, 8)}...): ${jobResult.error || 'Error Desconocido'}`;
                        listItem.style.backgroundColor = 'lightcoral';

                        // Update processedFiles
                        if (!processedFiles[fileKey]) {
                            processedFiles[fileKey] = [];
                        }
                        processedFiles[fileKey].push({
                            status: 'failed',
                            jobId: job_id,
                            quality: parseInt(document.getElementById(`quality-${fileKey}`).value),
                            resolution: parseInt(document.getElementById(`resolution-${fileKey}`).value),
                            output_format: document.getElementById(`output_format-${fileKey}`).value
                        });

                        // Hide the loader
                        const loader = listItem.querySelector('.loader');
                        if (loader) {
                            loader.style.display = 'none';
                        }
                    } else if (jobResult.status === 'processing') {
                        console.log(`Job ${job_id} is still processing.`);
                        // Show the loader for processing images
                        const loader = listItem.querySelector('.loader');
                        if (loader) {
                            loader.style.display = 'block';
                        }
                    }
                }

                if (data.all_finished) {
                    console.log("All jobs finished.");
                    progressContainer.style.display = 'none';
                    progressText.textContent = '';
                    resetState();
                } else {
                    setTimeout(() => checkProgress(requestId), 1000);
                }
            } catch (error) {
                console.error('Error al verificar el progreso:', error);
                progressText.textContent = error.message;
                resetState();
            }
        }

        function resetState() {
            isProcessing = false;
            convertButton.disabled = false;
            dropArea.classList.remove('disabled');
            window.onbeforeunload = null;
            jobIds = [];
            completedImages = 0;
            totalImagesToProcess = 0; // Reset total images
            progressContainer.style.display = 'none'; // Hide progress container
            progressText.textContent = ''; // Clear the text
            progressBar.style.width = '0%'; // Reset progress bar
            globalRequestId = null; // Reset global request ID
            jobFileMap = {}; // Reset jobFileMap - IMPORTANT to clear the array
        }

        window.onload = function() {
            resetState();
        }

        registerForm.addEventListener('submit', function(event) {
            console.log('Register form submitted');
            event.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            fetch('/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Registration successful');
                    updateUI(); // Update UI after successful login
                } else {
                    alert('Registration failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during registration');
            });
        });

        loginForm.addEventListener('submit', function(event) {
            console.log('Login form submitted');
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            fetch('/auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.token) {
                    localStorage.setItem('jwtToken', data.token);
                    alert('Login successful');
                    updateUI(); // Update UI after successful login
                } else {
                    alert('Login failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during login');
            });
        });

        logoutButton.addEventListener('click', function() {
            localStorage.removeItem('jwtToken');
            updateUI(); // Update UI after logout
        });
    </script>
</body>
</html>